<!-- templates/comments.html -->
<link rel="stylesheet" href="/static/css/tailwind.min.css">
<div class="comment-section max-w-3xl mx-auto py-6">
    <!-- 评论表单 -->
    <div class="comment-form bg-white rounded-lg shadow-sm p-4 mb-6">
        <h3 class="text-lg font-semibold text-gray-800 mb-3">发表评论</h3>
        <form id="commentForm" class="space-y-3">
            <input type="hidden" name="article_id" value="{{ article.id }}">
            <input type="hidden" name="parent_id" id="replyTo" value="">

            <div class="form-group">
        <textarea
                name="content"
                id="commentContent"
                rows="3"
                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                placeholder="写下您的评论..."
                required
        ></textarea>
            </div>

            <div class="flex justify-between items-center">
                <div class="reply-indicator hidden" id="replyIndicator">
                    <span class="text-sm text-blue-600">回复 <span id="replyUsername"></span></span>
                    <button type="button" id="cancelReply" class="ml-2 text-sm text-gray-500 hover:text-gray-700">取消
                    </button>
                </div>
                <button
                        type="submit"
                        class="px-5 py-2 bg-blue-600 text-white font-medium rounded-lg hover:bg-blue-700 transition-colors"
                >
                    发布评论
                </button>
            </div>
        </form>
    </div>

    <!-- 评论列表 -->
    <div id="commentsContainer">
        {% if comments_tree %}
            {% for node in comments_tree %}
                {% with comment=node %}
                    {% include 'comment_item.html' %}
                {% endwith %}
            {% endfor %}
        {% else %}
            <p class="text-center text-gray-500 py-8">暂无评论，成为第一个评论者吧！</p>
        {% endif %}
    </div>
</div>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const commentForm = document.getElementById('commentForm');
        const replyTo = document.getElementById('replyTo');
        const replyIndicator = document.getElementById('replyIndicator');
        const replyUsername = document.getElementById('replyUsername');
        const cancelReplyBtn = document.getElementById('cancelReply');

        // 回复按钮事件
        document.querySelectorAll('.reply-btn').forEach(btn => {
            btn.addEventListener('click', function () {
                const commentId = this.dataset.id;
                const username = this.dataset.username;

                replyTo.value = commentId;
                replyUsername.textContent = username;
                replyIndicator.classList.remove('hidden');

                document.getElementById('commentContent').focus();
            });
        });

        // 取消回复
        cancelReplyBtn.addEventListener('click', function () {
            replyTo.value = '';
            replyIndicator.classList.add('hidden');
        });

        // 表单提交
        commentForm.addEventListener('submit', async function (e) {
            e.preventDefault();

            const formData = new FormData(this);
            const submitBtn = this.querySelector('button[type="submit"]');
            const originalText = submitBtn.textContent;

            try {
                submitBtn.disabled = true;
                submitBtn.textContent = '发布中...';

                const response = await fetch('/api/comments', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    credentials: 'include',
                    body: JSON.stringify(Object.fromEntries(formData))
                });

                const result = await response.json();

                if (response.ok) {
                    // 成功处理（实际实现中需要动态添加评论到DOM）
                    alert('评论发布成功！');
                    commentForm.reset();
                    replyTo.value = '';
                    replyIndicator.classList.add('hidden');
                } else {
                    throw new Error(result.error || '发布评论失败');
                }
            } catch (error) {
                alert(error.message);
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = originalText;
            }
        });
    });
</script>