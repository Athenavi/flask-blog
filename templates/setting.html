<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç”¨æˆ·ä¸ªäººèµ„æ–™è®¾ç½®</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.12/cropper.min.css">
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.12/cropper.min.js"></script>
</head>
<body class="bg-gray-100 min-h-screen">
<!-- Navigation Bar -->
{% from 'header.html' import SimpleHeader %}
{{ SimpleHeader(title) }}
<div class="container mx-auto p-4 md:p-8 flex flex-col md:flex-row gap-6">
    <!-- å·¦ä¾§å¯¼èˆª -->
    <div class="w-full md:w-64 bg-white rounded-xl shadow-md p-4 md:p-6">
        <div class="space-y-4">
            <h4 class="text-lg font-bold mt-4">è®¾ç½®ä¸­å¿ƒ</h4>
            <nav class="space-y-2">
                <a href="#" onclick="showSection('profile')"
                   class="block p-2 text-gray-700 hover:bg-gray-50 rounded-lg transition-colors">ä¸ªäººèµ„æ–™</a>
                <a href="#" onclick="showSection('privacy')"
                   class="block p-2 text-gray-700 hover:bg-gray-50 rounded-lg">éšç§</a>
                <a href="#" onclick="window.open('/diy/space', '_blank')"
                   class="block p-2 text-gray-700 hover:bg-gray-50 rounded-lg">
                    ğŸ†“è‡ªå®šä¹‰ç©ºé—´</a>
                <a href="#" onclick="window.open('/profile/~recycle', '_blank')"
                   class="block p-2 text-gray-700 hover:bg-gray-50 rounded-lg">
                    ğŸ—‘ï¸å›æ”¶ç«™</a>
                <a href="#" onclick="window.open('/new', '_blank')"
                   class="block p-2 text-gray-700 hover:bg-gray-50 rounded-lg">ä¸Šä¼ æ–‡ç« â†—ï¸</a>
                <a href="#" onclick="window.open('/change-password', '_blank')"
                   class="block p-2 text-gray-700 hover:bg-gray-50 rounded-lg">ä¿®æ”¹å¯†ç â†—ï¸</a>
                <a onclick="fun_logout()"
                   class="block p-2 text-red-500 hover:bg-red-50 rounded-lg cursor-pointer">æ³¨é”€ç™»å½•</a>
            </nav>
        </div>
    </div>

    <!-- å³ä¾§å†…å®¹åŒºåŸŸ -->
    <div class="flex-1 bg-white rounded-xl shadow-md p-6">
        <!-- ä¸ªäººèµ„æ–™éƒ¨åˆ† -->
        <div id="profile" class="section">
            <h2 class="text-2xl font-bold mb-6">ä¸ªäººèµ„æ–™è®¾ç½®</h2>
            <div class="flex flex-col items-center mb-8">
                <img src="{{ avatar_url }}" alt="å¤´åƒ"
                     class="h-32 w-32 rounded-full cursor-pointer ring-4 ring-white shadow-lg hover:ring-blue-100 transition-all"
                     id="avatarImage" onclick="document.getElementById('avatarInput').click()"/>
                <input type="file" id="avatarInput" class="hidden" accept="image/*" onchange="showCropModal(event)"/>
                <span class="text-gray-500 text-sm mt-2">ç‚¹å‡»ä¿®æ”¹å¤´åƒ</span>
            </div>

            <!-- è£å‰ªæ¨¡æ€æ¡† -->
            <div id="avatarCropModal"
                 class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
                <div class="bg-white rounded-xl shadow-xl w-full max-w-2xl">
                    <div class="p-4 border-b flex justify-between items-center">
                        <h5 class="text-lg font-semibold">è£å‰ªå¤´åƒ</h5>
                        <button onclick="closeCropModal()" class="text-gray-400 hover:text-gray-600">âœ•</button>
                    </div>
                    <div class="p-4">
                        <img id="cropImage" src="" alt="é¢„è§ˆ" class="max-w-full h-96 object-contain"/>
                    </div>
                    <div class="p-4 border-t flex justify-end gap-2">
                        <button onclick="closeCropModal()" class="px-4 py-2 text-gray-700 hover:bg-gray-50 rounded-lg">
                            å–æ¶ˆ
                        </button>
                        <button id="cropButton" class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600">
                            ç¡®è®¤è£å‰ª
                        </button>
                    </div>
                </div>
            </div>

            <!-- è¡¨å• -->
            <form class="space-y-6">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">ç”¨æˆ·å</label>
                    <input type="text" placeholder="{{ username }}"
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">ç”µå­é‚®ç®±</label>
                    <p class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all">{{ userEmail }}</p>
                    æ¢ç»‘é‚®ç®±
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">ä¸ªäººç®€ä»‹</label>
                    <textarea rows="3" placeholder="{{ Bio }}"
                              class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all"></textarea>
                </div>
                <button type="submit"
                        class="w-full bg-blue-500 text-white py-2 px-4 rounded-lg hover:bg-blue-600 transition-colors">
                    ä¿å­˜ä¿®æ”¹
                </button>
            </form>
        </div>
    </div>
</div>

<script>
    // æ›´æ–°æ¨¡æ€æ¡†æ§åˆ¶é€»è¾‘
    let cropper;

    function showCropModal(event) {
        const file = event.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = (e) => {
                const img = document.getElementById('cropImage');
                img.src = e.target.result;
                document.getElementById('avatarCropModal').classList.remove('hidden');
                cropper = new Cropper(img, {
                    aspectRatio: 1,
                    viewMode: 1,
                });
            };
            reader.readAsDataURL(file);
        }
    }

    function closeCropModal() {
        document.getElementById('avatarCropModal').classList.add('hidden');
        if (cropper) {
            cropper.destroy();
        }
    }

    // æ›´æ–°è£å‰ªæŒ‰é’®äº‹ä»¶
    document.getElementById('cropButton').addEventListener('click', () => {
        const canvas = cropper.getCroppedCanvas();
        canvas.toBlob((blob) => {
            const formData = new FormData();
            formData.append('avatar', blob, 'avatar.webp');

            fetch('/setting/profiles?change_type=avatar', {
                method: 'PUT',
                body: formData
            }).then(response => response.json())
                .then(data => {
                    if (data.message === 'Avatar updated successfully') {
                        document.getElementById('avatarImage').src = URL.createObjectURL(blob);
                    }
                    closeCropModal();
                });
        }, 'image/webp');
    });

    function fun_logout() {
        const confirmed = confirm("ç¡®å®šè¦æ³¨é”€ç™»å½•å—ï¼Ÿ");
        if (confirmed) {
            window.location.href = "/logout";
        }
    }

    function showSection(section) {
        document.querySelectorAll('.section').forEach(function (el) {
            el.classList.add('hidden');
        });
        document.getElementById(section).classList.remove('hidden');
    }
</script>
<!-- Footer -->
{% from 'footer.html' import SimpleFooter %}
{{ SimpleFooter(SiteName,beian) }}
</body>
</html>
